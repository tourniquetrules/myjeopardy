{% extends "layout.html" %}

{% block content %}
<div id="board-container">
    <div id="game-grid">
        <!-- Headers -->
        <div class="grid-row header-row">
            {% for cat in round_data %}
            <div class="grid-header">{{ cat.category }}</div>
            {% endfor %}
        </div>
        <!-- Clues -->
        {% for row_idx in range(5) %}
        <div class="grid-row">
            {% for col_idx in range(6) %}
            <div class="grid-cell" id="cell-{{ col_idx }}-{{ row_idx }}">
                {% if not board_state[col_idx][row_idx] %}
                <span class="value">${{ round_data[col_idx].clues[row_idx].value }}</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>

    <!-- Scoreboard -->
    <div id="scoreboard">
        <!-- Populated via JS -->
    </div>

    <!-- Clue Overlay -->
    <div id="clue-overlay" style="display: none;">
        <div id="clue-content">
            <h2 id="clue-category">CATEGORY</h2>
            <div id="clue-text">Clue Text Here</div>
            <div id="media-container"></div>
            <div id="timer-bar"><div id="timer-fill"></div></div>
            <div id="buzz-indicator" style="display:none;">PLAYER NAME</div>
        </div>
    </div>
</div>

<script>
    const socket = io();

    function updateScoreboard(players) {
        const sb = $('#scoreboard');
        sb.empty();
        players.forEach(p => {
            sb.append(`<div class="player-score">
                <div class="p-name">${p.name}</div>
                <div class="p-score">$${p.score}</div>
            </div>`);
        });
    }

    socket.on('player_list_update', (players) => {
        updateScoreboard(players);
    });

    socket.on('score_update', (players) => {
        updateScoreboard(players);
    });

    socket.on('update_board_state', (data) => {
        $(`#cell-${data.cat_idx}-${data.clue_idx}`).empty();
    });

    socket.on('show_clue', (clue) => {
        $('#clue-category').text(clue.category);
        $('#clue-text').text(clue.text);
        $('#clue-overlay').show();

        // Handle media
        $('#media-container').empty();
        if (clue.media_url) {
            const ext = clue.media_url.split('.').pop().toLowerCase();
            if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) {
                $('#media-container').append(`<img src="${clue.media_url}" style="max-height: 50vh; max-width: 80%;">`);
            } else if (['mp3', 'wav', 'ogg'].includes(ext)) {
                $('#media-container').append(`<audio controls autoplay src="${clue.media_url}"></audio>`);
            } else if (['mp4', 'webm'].includes(ext)) {
                $('#media-container').append(`<video controls autoplay src="${clue.media_url}" style="max-height: 50vh; max-width: 80%;"></video>`);
            }
        }

        // Reset timer bar
        $('#timer-fill').css('width', '100%');
        $('#buzz-indicator').hide();
    });

    socket.on('show_daily_double', (clue) => {
        $('#clue-category').text(clue.category);
        $('#clue-text').text("DAILY DOUBLE");
        $('#clue-overlay').show();
        $('#media-container').empty();
        $('#timer-fill').css('width', '100%');
        $('#buzz-indicator').hide();

        // Play Sound?
    });

    socket.on('hide_clue', () => {
        $('#clue-overlay').hide();
    });

    socket.on('buzz_winner', (data) => {
        $('#buzz-indicator').text(data.name).show();
        // Maybe play sound
    });

    socket.on('start_timer', (data) => {
        const duration = data.duration;
        const fill = $('#timer-fill');
        fill.css('transition', `width ${duration}s linear`);
        fill.css('width', '0%');
    });

    socket.on('reset_timer', () => {
         const fill = $('#timer-fill');
         fill.css('transition', 'none');
         fill.css('width', '100%');
    });

    socket.on('start_final_jeopardy', (data) => {
        $('#game-grid').hide();
        $('#clue-overlay').show();
        $('#clue-category').text(data.category);
        $('#clue-text').text("FINAL JEOPARDY - Place your wagers!");
    });

    socket.on('show_fj_clue', (data) => {
         $('#clue-text').text(data.text);
         // Music?
    });

</script>
{% endblock %}
