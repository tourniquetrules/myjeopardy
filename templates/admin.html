{% extends "layout.html" %}

{% block content %}
<div class="admin-container">
    <div id="admin-controls-header" style="display:flex; justify-content:space-between; align-items:center; padding: 10px;">
        <h2>Host Control</h2>
        <h3 id="control-indicator" style="color: yellow;">Control: None</h3>
    </div>

    <div id="admin-grid">
        <!-- Headers -->
        <div class="grid-row" style="display: flex;">
            {% for cat in round_data %}
            <div class="grid-cell" style="height: 50px; background: #000033; color: white; font-size: 0.8rem; border: 1px solid white; display:flex; align-items:center; justify-content:center; flex:1;">
                {{ cat.category }}
            </div>
            {% endfor %}
        </div>

        {% for row_idx in range(5) %}
        <div class="grid-row">
            {% for col_idx in range(6) %}
            <button class="grid-cell admin-cell"
                    id="admin-cell-{{ col_idx }}-{{ row_idx }}"
                    onclick="selectClue({{ col_idx }}, {{ row_idx }})"
                    {% if board_state[col_idx][row_idx] %}disabled{% endif %}>
                ${{ round_data[col_idx].clues[row_idx].value }}
            </button>
            {% endfor %}
        </div>
        {% endfor %}
    </div>

    <div id="admin-controls">
        <h3>Current Clue</h3>
        <div id="admin-clue-info">None</div>
        <div id="admin-answer-info" style="font-weight:bold; color:red;"></div>

        <div id="wager-controls" style="display:none; border: 2px solid gold; padding: 10px; margin: 10px 0;">
            <h4>Daily Double Wager</h4>
            <div id="dd-control-info"></div>
            <input type="number" id="wager-input" placeholder="Enter Wager">
            <button onclick="submitWager()">Reveal Clue</button>
        </div>

        <div class="control-group">
            <button onclick="clearBuzzers()">Clear Buzzers (Manual)</button>
        </div>

        <div class="control-group" id="scoring-controls">
            <button onclick="grade(true)">Correct</button>
            <button onclick="grade(false)">Incorrect</button>
            <button onclick="closeClue()">Close Clue (No Winner)</button>
        </div>

        <h3>Current Buzzer: <span id="admin-buzzer">None</span></h3>

        <div id="manual-player-select" style="margin-top: 10px; border-top: 1px solid #555; padding-top: 10px;">
            <small>Manual Player Select (for Daily Double / Overrides):</small>
            <div id="player-select-buttons"></div>
        </div>
    </div>

    <hr>
    {% if current_round == 1 %}
    <button onclick="startRound2()" id="btn-start-r2" style="width: 100%; padding: 20px; background: silver; color: black; font-size: 1.5rem; margin-bottom: 10px;">Start Double Jeopardy</button>
    {% endif %}

    <button onclick="startFJ()" id="btn-start-fj" style="width: 100%; padding: 20px; background: gold; color: black; font-size: 1.5rem;">Start Final Jeopardy</button>

    <div id="fj-controls" style="display:none; border: 5px solid white; padding: 20px;">
        <h2>Final Jeopardy</h2>
        <button onclick="revealFJClue()">Reveal Clue (Start 30s Timer)</button>
        <div id="fj-players-list"></div>
    </div>
</div>

<script>
    const socket = io();
    let currentClue = null;
    let currentBuzzerSid = null;

    function selectClue(catIdx, clueIdx) {
        $('#wager-controls').hide();
        socket.emit('admin_select_clue', {cat_idx: catIdx, clue_idx: clueIdx});
    }

    function submitWager() {
        const wager = $('#wager-input').val();
        socket.emit('admin_set_wager', {wager: wager});
        $('#wager-controls').hide();
    }

    function openBuzzers() {
        socket.emit('admin_clear_buzzers');
        // trigger timer?
    }

    function clearBuzzers() {
        socket.emit('admin_clear_buzzers');
        $('#admin-buzzer').text("None");
        currentBuzzerSid = null;
    }

    function grade(isCorrect) {
        if (!currentClue) return;
        if (!currentBuzzerSid) {
            alert("No player buzzed in!");
            return;
        }

        const points = isCorrect ? currentClue.value : -currentClue.value;
        socket.emit('admin_update_score', {sid: currentBuzzerSid, points: points});

        if (isCorrect) {
            // Wait for server to close, or close manually?
            // Server now handles close sequence on correct.
            // But we should visually acknowledge?
            // closeClue(); // Don't call this, let server handle it via 'update_board_state'
        } else {
            // Incorrect, clear buzzer so others can try
            // clearBuzzers(); // Server handles this too
        }
    }

    function closeClue() {
        socket.emit('admin_close_clue');
        $('#admin-clue-info').text("None");
        $('#admin-answer-info').text("");
        $('#admin-buzzer').text("None");
        currentClue = null;
        currentBuzzerSid = null;
    }

    socket.on('show_clue', (clue) => {
        currentClue = clue;
        $('#admin-clue-info').text(`${clue.category} - $${clue.value}: ${clue.text}`);
        $('#admin-answer-info').text(`Answer: ${clue.answer}`);
    });

    socket.on('show_daily_double', (clue) => {
        currentClue = clue;
        $('#admin-clue-info').text(`${clue.category} - DAILY DOUBLE`);
        $('#admin-answer-info').text(`Answer: ${clue.answer}`);
        $('#wager-controls').show();
        $('#wager-input').val('');
        $('#dd-control-info').text('');
    });

    socket.on('assign_dd_control', (data) => {
        // Automatically select this player
        setBuzzer(data.sid, data.name);
        $('#dd-control-info').text(`Control: ${data.name}`);
    });

    socket.on('update_board_state', (data) => {
        $(`#admin-cell-${data.cat_idx}-${data.clue_idx}`).prop('disabled', true).css('visibility', 'hidden');
        // Reset local state
        $('#admin-clue-info').text("None");
        $('#admin-answer-info').text("");
        $('#admin-buzzer').text("None");
        currentClue = null;
        currentBuzzerSid = null;
    });

    socket.on('buzz_winner', (data) => {
        currentBuzzerSid = data.sid;
        $('#admin-buzzer').text(data.name);
    });

    // Final Jeopardy
    function startFJ() {
        if (confirm("Start Final Jeopardy? This cannot be undone.")) {
            socket.emit('admin_start_fj');
            $('#btn-start-fj').hide();
            $('#admin-grid').hide();
            $('#admin-controls').hide();
            $('#fj-controls').show();
        }
    }

    function revealFJClue() {
        socket.emit('admin_reveal_fj_clue');
    }

    function startRound2() {
        if(confirm("Start Double Jeopardy?")) {
             socket.emit('admin_start_round_2');
        }
    }

    socket.on('round_2_started', () => {
        location.reload();
    });

    socket.on('control_update', (data) => {
        $('#control-indicator').text("Control: " + data.name);
    });

    let fjPlayers = {}; // sid -> {name, wagered, answered, answerText, score, graded}

    function updatePlayers(players) {
        // Render Manual Select
        const container = $('#player-select-buttons');
        container.empty();
        players.forEach(p => {
             container.append(`<button onclick="setBuzzer('${p.sid}', '${p.name}')" style="margin:2px;">${p.name}</button>`);
        });

        // Sync fjPlayers
        players.forEach(p => {
            if (!fjPlayers[p.sid]) {
                fjPlayers[p.sid] = {name: p.name, wagered: false, answered: false, answerText: "", score: p.score, graded: false};
            } else {
                fjPlayers[p.sid].score = p.score;
            }
        });
        renderFJList();
    }

    socket.on('player_list_update', updatePlayers);
    socket.on('score_update', updatePlayers);

    function setBuzzer(sid, name) {
        currentBuzzerSid = sid;
        $('#admin-buzzer').text(name + " (Manual)");
    }

    socket.on('admin_fj_status', (data) => {
        // data: {sid, has_wager, has_answer, answer}
        if (fjPlayers[data.sid]) {
            fjPlayers[data.sid].wagered = data.has_wager;
            fjPlayers[data.sid].answered = data.has_answer;
            if (data.answer) fjPlayers[data.sid].answerText = data.answer;
            renderFJList();
        }
    });

    function renderFJList() {
        const div = $('#fj-players-list');
        div.empty();
        Object.keys(fjPlayers).forEach(sid => {
            const p = fjPlayers[sid];
            let html = `<div style="border: 1px solid white; margin: 5px; padding: 5px;">
                <strong>${p.name}</strong> ($${p.score}) -
                Wagered: ${p.wagered ? 'YES' : 'NO'} -
                Answered: ${p.answered ? 'YES' : 'NO'}`;

            if (p.answered) {
                html += `<br>Answer: <span style="color: yellow;">${p.answerText}</span>`;
                if (!p.graded) {
                    html += `
                    <button onclick="gradeFJ('${sid}', true)">Correct</button>
                    <button onclick="gradeFJ('${sid}', false)">Incorrect</button>`;
                } else {
                    html += ` <strong>(Graded)</strong>`;
                }
            }
            html += `</div>`;
            div.append(html);
        });
    }

    function gradeFJ(sid, correct) {
        if(fjPlayers[sid]) {
            fjPlayers[sid].graded = true;
            renderFJList();
        }
        socket.emit('admin_grade_fj', {sid: sid, correct: correct});
    }

</script>
{% endblock %}
