{% extends "layout.html" %}

{% block content %}
<div class="admin-container">
    <div id="admin-controls-header" style="display:flex; justify-content:space-between; align-items:center; padding: 10px;">
        <h2>Host Control — ✦ Christmas Special ✦</h2>
        <h3 id="control-indicator" style="color: yellow;">Control: None</h3>
    </div>
    <div style="display:flex; justify-content:space-between; align-items:center; padding: 5px 10px 0 10px;">
        <h4 id="buzzer-status" style="color: lightcoral; margin:0;">Buzzers: CLOSED</h4>
    </div>

    <div id="admin-grid">
        <!-- Headers -->
        <div class="grid-row" style="display: flex;">
            {% for cat in round_data %}
            <div class="grid-cell" style="height: 50px; background: #000033; color: white; font-size: 0.8rem; border: 1px solid white; display:flex; align-items:center; justify-content:center; flex:1;">
                {{ cat.category }}
            </div>
            {% endfor %}
        </div>

        {% for row_idx in range(5) %}
        <div class="grid-row">
            {% for col_idx in range(6) %}
            <button class="grid-cell admin-cell"
                    id="admin-cell-{{ col_idx }}-{{ row_idx }}"
                    onclick="selectClue({{ col_idx }}, {{ row_idx }})"
                    {% if board_state[col_idx][row_idx] %}disabled{% endif %}>
                ${{ round_data[col_idx].clues[row_idx].value }}
            </button>
            {% endfor %}
        </div>
        {% endfor %}
    </div>

    <div id="admin-controls">
        <h3>Current Clue</h3>
        <div id="admin-clue-info">None</div>
        <div id="admin-answer-info" style="font-weight:bold; color:red;"></div>

        <div id="wager-controls" style="display:none; border: 2px solid gold; padding: 10px; margin: 10px 0;">
            <h4>Daily Double Wager</h4>
            <div id="dd-control-info"></div>
            <div id="dd-max-wager-info" style="color: gold; margin: 5px 0;"></div>
            <input type="number" id="wager-input" placeholder="Enter Wager" min="0">
            <button onclick="submitWager()">Reveal Clue</button>
        </div>

        <div class="control-group">
            <button onclick="openBuzzers()">Open Buzzers (Manual)</button>
        </div>

        <div class="control-group" id="scoring-controls">
            <button onclick="grade(true)">Correct</button>
            <button onclick="grade(false)">Incorrect</button>
            <button onclick="closeClue()">Close Clue (Manual)</button>
        </div>

        <h3>Current Buzzer: <span id="admin-buzzer">None</span></h3>

        <div id="manual-player-select" style="margin-top: 10px; border-top: 1px solid #555; padding-top: 10px;">
            <small>Manual Player Select (for Daily Double / Overrides):</small>
            <div id="player-select-buttons"></div>
        </div>

        <div id="manual-score-controls" style="margin-top: 10px; border-top: 1px solid #555; padding-top: 10px;">
            <h4>Manual Score Adjustment</h4>
            <div>Selected Player: <span id="selected-player-name">None</span></div>
            <div style="margin-top: 8px;">
                <input type="number" id="score-input" placeholder="Points or New Score" style="width:120px;">
                <button onclick="addPoints()">Add Points</button>
                <button onclick="subtractPoints()">Subtract Points</button>
                <button onclick="setScore()">Set Score</button>
            </div>
            <div style="margin-top:6px;"><small>Hint: Use Set Score to assign an absolute value.</small></div>
        </div>
    </div>

    <hr>
    {% if current_round == 1 %}
    <button onclick="startRound2()" id="btn-start-r2" style="width: 100%; padding: 20px; background: silver; color: black; font-size: 1.5rem; margin-bottom: 10px;">Start Double Jeopardy</button>
    {% endif %}

    <button onclick="startFJ()" id="btn-start-fj" style="width: 100%; padding: 20px; background: gold; color: black; font-size: 1.5rem;">Start Final Jeopardy</button>

    <div id="fj-controls" style="display:none; border: 5px solid white; padding: 20px;">
        <h2>Final Jeopardy</h2>
        <button onclick="revealFJClue()">Reveal Clue (Start 30s Timer)</button>
        <div id="fj-players-list"></div>
    </div>
</div>

<script>
    const socket = io();
    let currentClue = null;
    let currentBuzzerSid = null;

    function selectClue(catIdx, clueIdx) {
        $('#wager-controls').hide();
        // disable until server confirms/show_clue
        $('.admin-cell').prop('disabled', true);
        socket.emit('admin_select_clue', {cat_idx: catIdx, clue_idx: clueIdx});
    }

    function submitWager() {
        let wager = parseInt($('#wager-input').val()) || 0;
        
        // Client-side validation
        if (window.ddMaxWager && wager > window.ddMaxWager) {
            alert(`Wager cannot exceed $${window.ddMaxWager}`);
            wager = window.ddMaxWager;
            $('#wager-input').val(wager);
            return;
        }
        if (wager < 0) {
            alert('Wager cannot be negative');
            return;
        }
        
        socket.emit('admin_set_wager', {wager: wager});
        $('#wager-controls').hide();
    }

    function openBuzzers() {
        socket.emit('admin_clear_buzzers');
        // trigger timer?
    }

    function clearBuzzers() {
        socket.emit('admin_clear_buzzers');
        $('#admin-buzzer').text("None");
        currentBuzzerSid = null;
    }

    function grade(isCorrect) {
        if (!currentClue) return;
        if (!currentBuzzerSid) {
            alert("No player buzzed in!");
            return;
        }

        const points = isCorrect ? currentClue.value : -currentClue.value;
        socket.emit('admin_update_score', {sid: currentBuzzerSid, points: points});

        if (isCorrect) {
            // Wait for server to show the answer; host must manually close the clue.
            // But we should visually acknowledge?
            // closeClue(); // Don't call this, let server handle it via 'update_board_state'
        } else {
            // Incorrect, clear buzzer so others can try
            // clearBuzzers(); // Server handles this too
        }
    }

    function closeClue() {
        socket.emit('admin_close_clue');
        $('#admin-clue-info').text("None");
        $('#admin-answer-info').text("");
        $('#admin-buzzer').text("None");
        currentClue = null;
        currentBuzzerSid = null;
    }

    socket.on('show_clue', (clue) => {
        currentClue = clue;
        $('#admin-clue-info').text(`${clue.category} - $${clue.value}: ${clue.text}`);
        $('#admin-answer-info').text(`Answer: ${clue.answer}`);
        // Indicate buzzers are closed when a clue is shown; host should open them
        $('#buzzer-status').text('Buzzers: CLOSED').css('color', 'lightcoral');
        // Disable selecting other clues until this one is closed
        $('.admin-cell').prop('disabled', true);
    });

    socket.on('show_daily_double', (clue) => {
        currentClue = clue;
        $('#admin-clue-info').text(`${clue.category} - DAILY DOUBLE`);
        $('#admin-answer-info').text(`Answer: ${clue.answer}`);
        $('#wager-controls').show();
        $('#wager-input').val('');
        $('#dd-control-info').text('');
        $('#dd-max-wager-info').text('');
        // Disable selecting other clues until the daily double is closed
        $('.admin-cell').prop('disabled', true);
    });

    socket.on('assign_dd_control', (data) => {
        // Automatically select this player
        setBuzzer(data.sid, data.name);
        $('#dd-control-info').text(`Player: ${data.name} | Score: $${data.score}`);
        $('#dd-max-wager-info').text(`Maximum Wager: $${data.max_wager}`);
        $('#wager-input').attr('max', data.max_wager);
        window.ddMaxWager = data.max_wager;
    });

    socket.on('update_board_state', (data) => {
        $(`#admin-cell-${data.cat_idx}-${data.clue_idx}`).prop('disabled', true).css('visibility', 'hidden');
        // Reset local state
        $('#admin-clue-info').text("None");
        $('#admin-answer-info').text("");
        $('#admin-buzzer').text("None");
        currentClue = null;
        currentBuzzerSid = null;
        // Re-enable cells after the clue is closed, but keep already-answered ones disabled
        $('.admin-cell').prop('disabled', false);
        $('.admin-cell').filter(function(){ return $(this).css('visibility') === 'hidden';}).prop('disabled', true);
    });

    socket.on('buzz_winner', (data) => {
        currentBuzzerSid = data.sid;
        $('#admin-buzzer').text(data.name);
        $('#buzzer-status').text('Buzzers: CLOSED').css('color', 'lightcoral');
    });

    socket.on('player_timed_out', (data) => {
        const who = data.name || data.sid;
        $('#admin-answer-info').text(`Player timed out: ${who}`);
        // Keep cells disabled - require admin to manually reopen buzzers
        $('.admin-cell').prop('disabled', true);
    });

    socket.on('hide_clue', () => {
        // Re-enable cells when the clue overlay is hidden, but preserve answered state
        $('.admin-cell').prop('disabled', false);
        $('.admin-cell').filter(function(){ return $(this).css('visibility') === 'hidden';}).prop('disabled', true);
        $('#admin-clue-info').text("None");
        $('#admin-answer-info').text("");
        $('#admin-buzzer').text("None");
        currentClue = null;
        currentBuzzerSid = null;
    });

    socket.on('select_rejected', (data) => {
        alert(data.reason || 'Selection rejected');
        // Re-enable cells (server refused selection)
        $('.admin-cell').prop('disabled', false);
    });

    socket.on('show_answer_text', (data) => {
        // Show the answer text in admin UI and indicate manual close is required
        $('#admin-answer-info').text(`Answer: ${data.text} (Awaiting manual close)`);
    });

    socket.on('buzzers_cleared', () => {
        $('#buzzer-status').text('Buzzers: OPEN').css('color', 'limegreen');
    });

    socket.on('buzzers_reopened', (data) => {
        $('#buzzer-status').text('Buzzers: OPEN').css('color', 'limegreen');
    });

    socket.on('buzzers_locked', () => {
        $('#buzzer-status').text('Buzzers: CLOSED').css('color', 'lightcoral');
    });

    // Final Jeopardy
    function startFJ() {
        if (confirm("Start Final Jeopardy? This cannot be undone.")) {
            socket.emit('admin_start_fj');
            $('#btn-start-fj').hide();
            $('#admin-grid').hide();
            $('#admin-controls').hide();
            $('#fj-controls').show();
        }
    }

    function revealFJClue() {
        socket.emit('admin_reveal_fj_clue');
    }

    function startRound2() {
        if(confirm("Start Double Jeopardy?")) {
             socket.emit('admin_start_round_2');
        }
    }

    socket.on('round_2_started', () => {
        location.reload();
    });

    socket.on('control_update', (data) => {
        $('#control-indicator').text("Control: " + data.name);
    });

    let fjPlayers = {}; // sid -> {name, wagered, answered, answerText, score, graded}

    function updatePlayers(players) {
        // Render Manual Select
        const container = $('#player-select-buttons');
        container.empty();
        players.forEach(p => {
             container.append(`<button onclick="setBuzzer('${p.sid}', '${p.name}')" style="margin:2px;">${p.name}</button>`);
        });

        // Sync fjPlayers
        players.forEach(p => {
            if (!fjPlayers[p.sid]) {
                fjPlayers[p.sid] = {name: p.name, wagered: false, answered: false, answerText: "", score: p.score, graded: false};
            } else {
                fjPlayers[p.sid].score = p.score;
            }
        });
        renderFJList();
        // Update selected player name if we have one
        if (currentBuzzerSid) {
            const sel = players.find(ps => ps.sid === currentBuzzerSid);
            $('#selected-player-name').text(sel ? sel.name : 'None');
        }
    }

    socket.on('player_list_update', updatePlayers);
    socket.on('score_update', updatePlayers);

    function setBuzzer(sid, name) {
        currentBuzzerSid = sid;
        $('#admin-buzzer').text(name + " (Manual)");
        $('#selected-player-name').text(name);
    }

    function addPoints() {
        if (!currentBuzzerSid) {
            alert('Select a player first'); return;
        }
        const points = parseInt($('#score-input').val()) || 0;
        if (points === 0) { alert('Enter points to add'); return; }
        socket.emit('admin_update_score', {sid: currentBuzzerSid, points: points});
        $('#score-input').val('');
    }

    function subtractPoints() {
        if (!currentBuzzerSid) { alert('Select a player first'); return; }
        const points = parseInt($('#score-input').val()) || 0;
        if (points === 0) { alert('Enter points to subtract'); return; }
        socket.emit('admin_update_score', {sid: currentBuzzerSid, points: -points});
        $('#score-input').val('');
    }

    function setScore() {
        if (!currentBuzzerSid) { alert('Select a player first'); return; }
        const score = parseInt($('#score-input').val());
        if (isNaN(score)) { alert('Enter a valid number'); return; }
        socket.emit('admin_set_score', {sid: currentBuzzerSid, score: score});
        $('#score-input').val('');
    }

    socket.on('admin_fj_status', (data) => {
        // data: {sid, has_wager, has_answer, answer}
        if (fjPlayers[data.sid]) {
            fjPlayers[data.sid].wagered = data.has_wager;
            fjPlayers[data.sid].answered = data.has_answer;
            if (data.answer) fjPlayers[data.sid].answerText = data.answer;
            renderFJList();
        }
    });

    function renderFJList() {
        const div = $('#fj-players-list');
        div.empty();
        Object.keys(fjPlayers).forEach(sid => {
            const p = fjPlayers[sid];
            let html = `<div style="border: 1px solid white; margin: 5px; padding: 5px;">
                <strong>${p.name}</strong> ($${p.score}) -
                Wagered: ${p.wagered ? 'YES' : 'NO'} -
                Answered: ${p.answered ? 'YES' : 'NO'}`;

            if (p.answered) {
                html += `<br>Answer: <span style="color: yellow;">${p.answerText}</span>`;
                if (!p.graded) {
                    html += `
                    <button onclick="gradeFJ('${sid}', true)">Correct</button>
                    <button onclick="gradeFJ('${sid}', false)">Incorrect</button>`;
                } else {
                    html += ` <strong>(Graded)</strong>`;
                }
            }
            html += `</div>`;
            div.append(html);
        });
    }

    function gradeFJ(sid, correct) {
        if(fjPlayers[sid]) {
            fjPlayers[sid].graded = true;
            renderFJList();
        }
        socket.emit('admin_grade_fj', {sid: sid, correct: correct});
    }

</script>
{% endblock %}
